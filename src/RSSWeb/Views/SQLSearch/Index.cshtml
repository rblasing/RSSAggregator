<!-- Copyright 2020 Richard Blasingame. All rights reserved. -->

<script type="text/javascript">
   window.onload = function() {
      let txt = document.getElementById('txtKeyword');
      let btn = document.getElementById('btnKeyword');

      txt.addEventListener("input", function ()
      {
         btn.disabled = (this.value === '');
      });
   }
</script>

@model System.Data.DataTable

@{
   ViewBag.Title = "Search";
   Layout = "~/Views/Shared/_Layout.cshtml";
}

<div style="width: 3%; display: inline-block"></div>

<div style="width: 94%; display: inline-block">
@using (Html.BeginForm())
{
   @Html.AntiForgeryToken();

   <!-- Don't publish SQL in real-world projects! -->

   <br/>
   <div><i>What kinds of media elements have been published in items, and how many of each?</i></div>
   <code>WITH t AS (SELECT xml.value('data(/item[1]/enclosure[1]/@("@type"))', 'nvarchar(50)') AS type FROM rss_item WHERE xml.exist('/item/enclosure') = 1)<br/>
   SELECT t.type [Media Type], COUNT(*) [Count] FROM t<br/>
   GROUP BY t.type</code>
   <br/><input type="submit" name="Execute" value="Media types" /><br/><br/>

   <div><i>How many items have been published on each day of the week?</i></div>
   <code>WITH t AS (SELECT xml.value('upper-case(substring(string((/item/pubDate)[1]), 1, 3))', 'nchar(3)') AS d FROM rss_item WHERE xml.exist('/item/pubDate') = 1)<br/>
   SELECT t.d [Day], COUNT(*) [Count] FROM t<br/>
   GROUP BY t.d ORDER BY COUNT(*) DESC</code>
   <br/><input type="submit" name="Execute" value="Daily distribution" /><br/><br/>

   <div><i>Who contributed to items published in NPR's</i> All Thing's Considered <i>feed?</i></div>
   <code>SELECT DISTINCT CAST(xml.query('declare namespace dc="http://purl.org/dc/elements/1.1/"; /item/dc:creator/text()') AS NVARCHAR(400)) FROM rss_item WHERE<br />
   xml.exist('declare namespace dc="http://purl.org/dc/elements/1.1/"; /item/dc:creator') = 1 AND <br/>
   feed_id = (SELECT feed_id FROM rss_feed WHERE title = 'NPR All Things Considered')<br />
   ORDER BY [Creator];
   </code>
   <br/><input type="submit" name="Execute" value="Creators" /><br/><br/>

   <div><i>Static keyword search:</i></div>
   <code>SELECT title [Title] FROM rss_item WHERE<br/>
   xml.exist('/item/description/text()[contains(lower-case(.), "nasa")]') = 1</code>
   <br/><input type="submit" name="Execute" value="NASA references" /><br/><br/>

   <div><i>Parameterized keyword search:</i></div>
   <code>SELECT title [Title] FROM rss_item WHERE<br/>
   title LIKE @("@keyword") OR xml.exist('/item/description/text()[contains(lower-case(.), sql:variable(\"@("@keyword")\"))]') = 1</code>
   <br/><input type="text" name="txtKeyword" id="txtKeyword" /><input type="submit" name="Execute" value="Keyword search" id="btnKeyword" disabled />
   
   if (Model != null)
   {
      <hr />

      <table>
         <thead>
            <tr><td colspan="@Model.Columns.Count"><input type="submit" name="Execute" value="Export" style="margin-bottom: 6px" /></td></tr>
            <tr>
               @foreach (System.Data.DataColumn col in Model.Columns)
               {
                  <th style="padding-right: 20px">@col.Caption</th>
               }
            </tr>
         </thead>
         <tbody>
            @foreach (System.Data.DataRow row in Model.Rows)
            {
               <tr>
                  @foreach (var cell in row.ItemArray)
                  {
                     <td style="padding-right: 20px">@cell.ToString()</td>
                  }
               </tr>
            }
         </tbody>
      </table>
   }
}
</div>

<div style="width: 3%; display: inline-block"></div>
